!function t(e,s,n){function i(a,o){if(!s[a]){if(!e[a]){var c="function"==typeof require&&require;if(!o&&c)return c(a,!0);if(l)return l(a,!0);var r=new Error("Cannot find module '"+a+"'");throw r.code="MODULE_NOT_FOUND",r}var u=s[a]={exports:{}};e[a][0].call(u.exports,function(t){var s=e[a][1][t];return i(s?s:t)},u,u.exports,t,e,s,n)}return s[a].exports}for(var l="function"==typeof require&&require,a=0;a<n.length;a++)i(n[a]);return i}({1:[function(t,e,s){"use strict";var n={container:Util.getCurrentTab(),onlinePublishHostIdx:0,publishId:$("#main-tab-container").data("publishId"),proxy:{publishInfo:"/publish/apply/getAll.do",publishHistory:"/publish/shell/scripts.do",getBuildLog:"/publish/shell/getBuildLog.do",getAppLog:"/publish/shell/getRemotelog.do",applyOnline:"/publish/apply/submit.do",check:"/publish/shell/checkProject.do",updateResource:"/publish/shell/git",build:"/publish/shell/build.do",beforeSync:"/publish/shell/preSync.do",syncFile:"/publish/shell/syncfile.do",afterSync:"/publish/shell/afterSync.do",setTag:"/publish/shell/gitTag.do",finishPublish:"/publish/apply/finish.do",revertPublish:"/publish/shell/rollback.do",checkHealth:"/publish/shell/checkHealth.json"},init:function(){var t=this;Util.Tab.init(t.getLogTabElem(),{onClick:function(e,s){"编译日志"===$.trim(e.text())&&!e[0].hasGettedLog&&t.setBuildLog(s),e[0].hasGettedLog=!0},onRefresh:function(e,s){"编译日志"===$.trim(e.text())&&t.setBuildLog(s)}}),t.initPublishInfo(function(){t.renderPublishInfo.apply(t,arguments),t.setPublishHistory(function(){t.setPageShow(t.publishInfoData),t.bindEvents()})})},bindEvents:function(){var t=this;t.container.on("click.PublishAction",".-collapsed",function(){$(this).toggleClass("icon-minus"),$(this).closest(".-pc-list").find(".-info-body").slideToggle()}).on("click.PublishAction",".-pre-publish",function(){var e=$(this).parent().loading({modal:{opacity:40},loader:{cls:"small-circle",width:15,height:15}});t.publishAction({pre:!0,host:t.publishInfoData.preHost,check:!0,update:!0,build:!(1==t.publishInfoData.type),beforeSync:t.publishInfoData.beforeSync,syncFile:!0,afterSync:t.publishInfoData.afterSync},function(){e.remove()},{build:{data:{online:!1}}},function(){t.publishInfoData.idx=0,t.container.find(".-apply-online-btn").find("span").text("发布上线")})}).on("click.PublishAction",".-apply-online-btn",function(){var e=$(this).parent().loading();t.publishBtnHandle(function(){e.remove()})}).on("click.PublishAction",".-revert-btn",function(){var e=$(this),s=$(this).parent().loading({modal:{opacity:40},loader:{cls:"small-circle",width:15,height:15}});Util.baseAjax({url:t.proxy.revertPublish,data:{applyId:t.publishId},complete:function(){s.remove()}},function(t){Util.baseSuccessTips(t,"回滚成功","回滚失败"),t.success&&(this.container.find(".-pre-publish").parent().loading(),this.container.find(".-apply-online-btn").parent().loading(),e.parent().loading())})}).on("click.PublishAction",".-app-log",function(){var e=$(this).closest(".pc-info-header").find(".-ip-code-container").text().split(":")||["",""];Util.baseAjax({url:t.proxy.getAppLog,data:{applyId:t.publishId,host:e[0],port:e[1]}},function(s){Util.baseSuccessTips(s,"获取app 日志成功","获取app 日志失败"),Util.Tab.add(t.getLogTabElem(),{text:e.join(":"),closed:!0,selected:!0},function(t){t.html("<pre>"+(s.success?s.data:s.msg)+"</pre>")})})}).on("click.PublishAction",".-go-on-next-host.btn-success",function(){var e=$(this).parent();e.remove(),t.onlinePublish(null,!1)}).on("click.PublishAction",".-health-check:not(.disabled)",function(){var e=$(this),s=e.parent(),n=s.loading({modal:{opacity:40},loader:{cls:"small-circle",width:15,height:15}});e.addClass("disabled"),Util.baseAjax({url:t.proxy.checkHealth,data:{applyId:t.publishId,idx:t.onlinePublishHostIdx-1},complete:function(){e.removeClass("disabled"),n.remove()}},function(t){return t=t||{},t.success?(e.addClass("success-cor").append('<i class="iconfont icon-success d-ib ml-10px  va-t"></i>'),void s.nextAll(".-go-on-next-host").removeClass("disabled").addClass("btn-success")):(Util.baseSuccessTips(t,t.msg||"发布成功正在继续发布中",t.msg||"尚未完成发布，请稍后重新发布"),!1)})})},isEmptyStep:function(t){var e=!0;return $.each(t,function(){return e=!(this===!0)}),e},setPublishHistory:function(t){var e=this;Util.baseAjax({url:e.proxy.publishHistory,data:{applyId:e.publishId}},function(s){var n="";return Util.baseSuccessTips(s,"获取发布历史成功","获取发布历史失败"),!(!s.success||!s.data)&&(e.publishInfoData.hisOnline=s.data.online,e.publishInfoData.hisPre=s.data.pre,$.isFunction(t)&&t.call(e,s.data),!$.isEmptyObject(s.data.pre)&&(n+=e.isEmptyStep(s.data.pre)?"":e.getStepTpl({pre:!0,host:s.data.pre.host,check:s.data.pre.check,update:s.data.pre.update,build:s.data.pre.build,beforeSync:s.data.pre.beforeSync,syncFile:s.data.pre.syncFile,afterSync:s.data.pre.afterSync},!0)),!$.isEmptyObject(s.data.online)&&$.each(s.data.online.hosts,function(){n+=e.isEmptyStep(this)?"":e.getStepTpl({pre:!1,host:this.host,build:this.build,beforeSync:this.beforeSync,syncFile:this.syncFile,afterSync:this.afterSync},!0)}),void e.getStepStatusContainerElem().html(n))})},setBuildLog:function(t){var e=this;Util.baseAjax({url:e.proxy.getBuildLog,data:{applyId:e.publishId}},function(e){Util.baseSuccessTips(e,"获取编译日志成功","获取编译日志失败"),t.html("<pre>"+(e.success?e.data:e.msg)+"</pre>")})},initPublishInfo:function(t){var e=this;Util.baseAjax({url:e.proxy.publishInfo,data:{id:e.publishId}},function(s){s.success&&s.data&&$.isFunction(t)&&t.call(e,s.data)})},renderPublishInfo:function(t){var e=$.extend(!0,{},t.apply,t.project);this.publishInfoData=$.extend(!0,{},e),this.onlineHostArr=(this.publishInfoData.onlineHost||"").split("\n"),this.onlinePublishHostIdx=e.idx,e.publishTitle=t.apply.title,e.gmtModified=Util.Date.format(e.gmtModified,"yyyy/mm/dd hh:mm:ss"),e.type=1===e.type?"静态资源":"JAVA 资源",e.status=this.statusMap(e.status),Util.Form.loadData(this.container.find("form"),e)},setPageShow:function(t){var e=this.container.find(".-pre-publish"),s=this.container.find(".-revert-btn"),n=this.container.find(".-apply-online-btn"),i=!1;1===t.type&&Util.Tab.close(this.getLogTabElem(),1),1===t.flag&&n.removeClass("btn-success").find("span").text("发布线上"),17===t.status?(n.parent().loading(),s.parent().loading(),s.text("已回滚"),e.parent().loading()):15===t.status?(e.parent().loading(),n.text("发布已完成"),n.parent().loading()):t.idx>=t.hisOnline.hosts.length&&n.find("span").text("完成发布"),t.hisOnline.hosts&&(t.hisOnline.hosts[0].syncFile&&s.parent().removeClass("d-n"),0===t.type&&($.each(t.hisOnline.hosts[0],function(){return i=!!this}),i&&s.removeClass("d-n")))},flagMap:function(t){switch(+t){case-1:return"删除";case 0:return"未审核";case 1:return"正常";case 2:return"审核未通过";default:return t}},statusMap:function(t){switch(+t){case 0:return"创建完成";case 1:return"更新";case 2:return"编译通过";case 3:return"编译失败";case 4:return"同步预发成功";case 5:return"同步预发失败";case 6:return"重置预发成功";case 7:return"重置预发失败";case 8:return"等待发布";case 10:return"线上编译成功";case 11:return"线上编译失败";case 12:return"线上文件同步";case 13:return"线上发布成功";case 15:return"发布单已完成";case 17:return"发布单已回滚";default:return t}},getLogTabElem:function(){var t=this.container.find(".-log-tab-container");return this.getLogTabElem=function(){return t},t},getStepStatusContainerElem:function(){var t=this.container.find(".-step-status-container");return this.getStepStatusContainerElem=function(){return t},t},destroy:function(){this.grid.destroy(),this.container.off(".ProjectController")},publishBtnHandle:function(t,e){var s=this,n=s.publishInfoData.hisOnline,i=$.isArray(n.hosts)?n.hosts:[];s.publishInfoData.idx>=s.publishInfoData.hisOnline.hosts.length&&15!=s.publishInfoData.status&&17!=s.publishInfoData.status?s.confirmPublishFinish():1==s.publishInfoData.flag?s.onlinePublish(t,void 0==e?1!=s.publishInfoData.type&&!(i[0]&&i[0].build):e):Util.baseAjax({url:s.proxy.applyOnline,data:{id:s.publishId},complete:function(){$.isFunction(t)&&t()}},function(t){Util.baseSuccessTips(t,"申请上线提交成功，等待审核","申请上线提交失败")})},confirmPublishFinish:function(){var t=this;new $.Dialog({header:{title:"确认发布完成"},content:'<div class="dialog-content text-base-red p-20px fz-14px"> <i class="iconfont icon-info mr-5px"></i><span class="d-ib va-t ml-10px">您确定该发布单发布完成吗？<br/>确认完成后不能再次预发？</span></div>',style:{width:310},buttons:[{text:"确定",icon:"iconfont icon-confirm",cls:"btn btn-success",handle:function(e){Util.baseAjax({url:t.proxy.finishPublish,data:"id="+t.publishId},function(s){Util.baseSuccessTips(s,"确认发布完成成功","确认发布完成失败"),s.success&&(e.close(),t.container.find(".-pre-publish").parent().loading(),t.container.find(".-apply-online-btn").text("发布已完成"))})}},{text:"取消",icon:"iconfont icon-cancel",cls:"btn btn-danger",handle:function(t){t.close()}}]})},onlinePublish:function(t,e){var s=this;s.publishAction({host:s.onlineHostArr[s.onlinePublishHostIdx],check:!0,update:!0,build:e,beforeSync:s.publishInfoData.beforeSync,syncFile:!0,afterSync:s.publishInfoData.afterSync},function(){$.isFunction(t)&&t()},{build:{data:{online:!0}},beforeSync:{data:{online:!0,idx:s.onlinePublishHostIdx}},syncFile:{data:{online:!0,idx:s.onlinePublishHostIdx}},afterSync:{data:{online:!0,idx:s.onlinePublishHostIdx}}},function(t){0===s.publishInfoData.type&&s.container.find(".-revert-btn").removeClass("d-n"),s.onlinePublishHostIdx<s.publishInfoData.hisOnline.hosts.length?t.append(' <div class="cf p-10px ta-c"><div class="d-ib"><span class="btn -health-check mr-10px">健康检查</span></div><span class="btn -go-on-next-host disabled">继续发布</span></div></div>').get(0).scrollIntoView():(s.container.find(".-apply-online-btn").parent().loading(),s.confirmPublishFinish())}),++s.onlinePublishHostIdx},getBaseTpl:function(){var t=this.container.find(".-publish-status-tpl").html();return this.getBaseTpl=function(){return t},t},stepItemTpl:'<li class="{history} p-5px fz-14px wait-cor {cls}"><span class="fl-l w-90">{text}</span><i class="iconfont {status} d-ib"></i></li>',getStepTpl:function(t,e){return Util.renderTpl(this.getBaseTpl(),{preOrOnline:t.pre?"预发":"线上",host:t.host,check:t.check?Util.renderTpl(this.stepItemTpl,{cls:"-step-check",text:"检查",history:e?"success-cor":"d-n",status:e?"icon-success":"small-circle"}):"",update:t.update?Util.renderTpl(this.stepItemTpl,{cls:"-step-update",text:"更新",history:e?"success-cor":"d-n",status:e?"icon-success":"small-circle"}):"",build:t.build?Util.renderTpl(this.stepItemTpl,{cls:"-step-build",text:"编译",history:e?"success-cor":"d-n",status:e?"icon-success":"small-circle"}):"",beforeSync:t.beforeSync?Util.renderTpl(this.stepItemTpl,{cls:"-step-before-sync",text:"同步前执行脚本",history:e?"success-cor":"d-n",status:e?"icon-success":"small-circle"}):"",syncFile:t.syncFile?Util.renderTpl(this.stepItemTpl,{cls:"-step-sync-file",text:"同步文件",history:e?"success-cor":"d-n",status:e?"icon-success":"small-circle"}):"",afterSync:t.afterSync?Util.renderTpl(this.stepItemTpl,{cls:"-step-after-sync",text:"同步后执行脚本",history:e?"success-cor":"d-n",status:e?"icon-success":"small-circle"}):""})},publishStepAction:function(t,e,s,n){var i=this,l=0,a=$(),o=function(){Util.baseAjax({url:t[l].url,data:t[l].data,timeout:0,beforeSend:function(){e.find("."+t[l].target).removeClass("d-n")},complete:function(n,i){"success"!==i&&($.isFunction(s)&&s(),e.find("."+t[l].target).addClass("error-cor").find(".small-circle").removeClass("small-circle").addClass("icon-error"))}},function(i){a.append("<pre>"+(i.success?i.data:'<span class="error-cor">'+i.msg+"</span>")+"</pre>"),e.find("."+t[l].target).addClass(i.success?"success-cor":"error-cor").find(".small-circle").removeClass("small-circle").addClass(i.success?"icon-success":"icon-error"),++l,i.success&&l<t.length?o(l):$.isFunction(s)&&s(),l===t.length&&i.success&&$.isFunction(n)&&n(e)})};Util.Tab.select(i.getLogTabElem(),"first",function(t){a=t}),$.isArray(t)&&t.length&&o()},filterStep:function(t,e){var s,n=this,i=[],l=function(n){return s=null,t[n]&&(s=$.extend(!0,{},e[n]),!0)};return e=e||{},l("check")&&i.push($.extend(!0,{url:n.proxy.check,target:"-step-check",data:{projectId:n.publishInfoData.projectId}},s)),l("update")&&i.push($.extend(!0,{url:n.proxy.updateResource,target:"-step-update",data:{applyId:n.publishId}},s)),l("build")&&i.push($.extend(!0,{url:n.proxy.build,target:"-step-build",data:{applyId:n.publishId}},s)),l("beforeSync")&&i.push($.extend(!0,{url:n.proxy.beforeSync,target:"-step-before-sync",data:{applyId:n.publishId,online:!1,idx:0}},s)),l("syncFile")&&i.push($.extend(!0,{url:n.proxy.syncFile,target:"-step-sync-file",data:{applyId:n.publishId,online:!1,idx:0}},s)),l("afterSync")&&i.push($.extend(!0,{url:n.proxy.afterSync,target:"-step-after-sync",data:{applyId:n.publishId,online:!1,idx:0}},s)),i},publishAction:function(t,e,s,n){var i=this,l=$(i.getStepTpl(t));arguments.length<4&&$.isFunction(s)?(n=s,s={}):4===arguments.length&&"object"===$.type(n)&&(s=[n,n=s][0]),i.getStepStatusContainerElem().append(l),i.publishStepAction(i.filterStep(t,s),l,e,n)}};n.init()},{}]},{},[1]);